# Задание «Комплексное» («Найди ошибки»)

### Короткая версия
Пункты по ошибкам:
1. **Ошибка:** в консоле "export 'default' (imported as 'initMap') was not found in './map'. **Причина:** в файле map делается точечный экспорт функции, а в файле index делается импорт по умолчанию. **Исправление:** сделал точечный импорт функции initMap. **Причина по которой могла быть допущена ошибка:** был в спешке написан index.js в котором не заметили отсутствие точечного импорта функции.
1. **Ошибка:** белый экран. Причина: размер карты по высоте равен 0. **Исправление:** добавил стили для растягивания элементов карты на весь экран, согласно ТЗ. **Причина по которой могла быть допущена ошибка:** подключен новый файл стилей без необходимого растягивания, случайно удалены стили при рефакторинге.
1. **Ошибка:** не видно данных на всей области карты мира. **Исправление:** согласно документации, добавлен экземпляр objectManager в экземпляр карты myMap. **Причина по которой могла быть допущена ошибка:** рефакторинг функции, случайное удаление.
1. **Ошибка:** данные видны не на области Москвы. **Исправление:** в файле mappers.js исправлена очередность передачи географических координат, согласно общепринятыму стандарту широта\долгота - latitude\longitude. **Причина по которой могла быть допущена ошибка:** при написании обработчика данных с сервера легко можно было перепутать lat и long местами, если не знать, что это значит (да и зная, тоже легко перепутать)
1. **Ошибка:** внешний вид кластера не отображает неисправные станции. **Исправление:** убрать переопределение шаблона кластера в файле map. **Причина по которой могла быть допущена ошибка:** остался лишний код от примеров с API Карт.
1. **Ошибка:** не открывается балун с информацией по станции. **Исправление:** стрелочные функции изменены на обычные, что бы сохранялся контекст this при их вызове. **Причина по которой могла быть допущена ошибка:** плохое понимание работы функционала API и привычка везде исплозовать новые стрелочные функции.
1. **Ошибка:** некоректно отображается график работы станции. **Исправление:** убрано нулевое ограничение на максимальное значение подключений. **Причина по которой могла быть допущена ошибка:** из увиденного, максимальное количество подкючений было 10, поэтому вероятно значение 0 это просто опечатка значения 10.

### Другие улучшения
1. Исправлена верстка попапа - был пропущен закрывающий div
2. Удалены неиспользуемые файлы и функции

### Длинная версия с потоком мыслей:
1) Запустил проект, увидел предупреждение. 
Запустил в браузере, **увидел ошибку**.
Зашёл в index.js увидел импорт. Перешёл в импортируемый файл и увидел отсутствие export default. Вернулся в index.js добавил фигурные скобки для импорта нужной функции.
2) Перезагрузил страницу, **белый экран.** Открыл апи яндекс карт, и открыл две ссылки (песочнику и быстрый старт).
Посмотрел на песочнику и на код initMap. Что-то похожее, но пошёл смотреть быстрый старт. Там по пунктам пошёл проверять.
на 2 этапе требовалось задать ширину и высоту. Проверил приложение, высота контейнера 0. Зашёл в стили и добавил ширину и высоту во всю область. После перезагрузки карта появилась.
3) **На Москве не видно было точек**. 
Посмотрел документацию, после создания ObjectManager, он добавлялся в geoObjects карты. В исходном коде такой строчки не было, ObjectManager просто инициализировался и ничего с ним не делалось. По документации добавил myMap.geoObjects.add(objectManager) после блока с заданием опций кластера, как в примерах песочницы.
В функции инициализии было добавление фильтров. На всякий случай закоментировал временно блок с фильтрами, что бы исключить их влияние. Не помогло, ошибка была не в них.
Пошёл смотреть откуда приходят данные. 
Законсолил, приходят верные данные(согласно документации типы и параметры объектов все заданы).
Посмотрел песочницу, как там данные добавляются. Заметил, что координаты приходят в виде 37..,55.., а в песочнице 55..,37... Так же при инициализации апи центр был задан, как 55..,37... Понял, что данные с функции loadList приходят не верные. Функция получала данные с бекенда и обрабатывала функцией mapServerData.
В функции довольно очевидно следовало поменять obj.lat и obj.long местами.
После перезагрузки страницы увидел кластеры и точки. Поприблежал и поудалял, понял, как это работает.
4) Вернулся к описанию, что бы понять, что не работает дальше. Дошёл до пункта, про **иконку кластера отображающую проблему с неисправной станцие**й.
Блок фильтра и блок деталей объекта отпадает логически, остается инициализация карты и менеджера объектов, и подгрузка данных с сервера в файле map.js
Данные с сервера не содержат информации по кластерам, так что этот кусок кода тоже отпадает из проблемных.
Остается код инициализации карты, менеджера объектов и задача опции preset для кластера. Ради эксперемента закоментировал код, что бы посмотреть, на что он влияет. Бинго, кластеры стали правильными круговыми диаграммими.
5) Клик на метку **должен выдавать информацию, но ничего не выдает**. При этом, если после клика на метку, что-то подвигать\покликать, появляются ошибки в консоле.
Посмотрел пример апи "Загрузка данных для балуна метки по требованию". С кодом логических расхождений не было, разница в основном в названии ключа с данными (properties.details).
Закоментировал установку своего шаблона балуна, посмотрел. Балун вызывается, поэтому предположил, что ошибка в шаблоне getDetailsContentLayout
После открытия, увидел шаблон, в котором были условия. Визуально бросилось в глаза отсутствие закрывающего тега div(спасибо формитарованию). Наверное стало лучше, но не помогло.
Начал разбор блока деталей, по клику. Если закоментировать всю кастомную обработку клика и октрытие балуна (+ закоментировать geoObjectOpenBalloonOnClick), тогда балун всё равно не работает. Значит ошибка не в передаче данных и кастомном открытии, а попрежнему в шаблоне.
После изучения документации и кода, заметил, что переопределение функций build и clear требуют инициализацию базового метода с вызовом из текущего контекста (call(this)). Функции в шаблоне объявлены как стрелочные и не имеют своего контекста. Изменил на function. Балун начал открываться. Раскоментировал кастомный вызов балуна.
6) Балун открывается, но **не видно данных для графика**
В функцияю createChart вставил пример с документации chart.js. Заработало. Значит ошибка в подаваемых данных или опциях.
Функции получения цвета и меток довольно простые, но мало ли.. комментируем установку цветов и меток. Данных нет. 
Комментирую все опции. Данные есть, значит ошибка в опциях.
Беглый взгляд на опции, подозрительное max: 0. Удаляю, опции расскоментирую, проверяю. Данные есть.
Расскоменчиваю метки и цвета. Работает.
7) Забежал в файлы в которых не были ошибки, на случай, а вдруг пропустил. **Заметил неиспользуемую функцию** шаблона попапа (IDE подсветил). Удалил.

#### _P.S._
_Коммител позже, уже после выполнения задания, поэтому есть разница в коммите по изменению экспорта по умолчанию. Сделал экспорт по умолчанию, по причине того, что это была единственная функция в файле, но изменил на точечный экспорт, после анализа стиля кода (нет ниодного экспорта поумолчанию)_ 